/*! backend.js 2018-05-25 */

function del(t,n){return dialog.confirm(n,function(){location.href=$(t).attr("href")}),!1}function callfunc(t,n,i,a){if(i){"string"==typeof i&&(i=i.split(","));var e=i.indexOf("###");0<=e?i[e]=t:i=[t].concat(i)}else i=[t];return window[n]?window[n].apply(a,i):t}function iif(t,n,i){return"0"===t&&(t=0),t?n:i}Number.prototype.format=function(t){void 0===t&&(t=2);for(var n=this.toFixed(t).split("."),i=[],a=n[0].split(""),e=a.length,o=0;o<e;o++)0<o&&o%3==0&&i.unshift(","),i.unshift(a[e-o-1]);return i.join("")+(2==n.length?"."+n[1]:"")},String.prototype.compile=function(r,t){if(t){var n=[];for(var i in r)n.push(this.compile(r[i]));return n.join("\n")}return this.replace(/\{@([\w\d\.]+)(?:\|([\w\d]+)(?:\s*=\s*([\w\d,\s#]+))?)?\}/g,function(t,n,i,a){if(0<n.indexOf(".")){for(var e=n.split("."),o=r,s=0;s<e.length;s++){if(!o[e[s]]){o="";break}o=o[e[s]]}return callfunc(o,i,a)}return r[n]?callfunc(r[n],i,a,r):""})};var dialogTpl='<div class="modal fade" id="{@id}" tabindex="-1" role="dialog" aria-labelledby="{@id}Label" aria-hidden="true">\n    <div class="modal-dialog">\n        <div class="modal-content">\n            <div class="modal-header">\n                <h4 class="modal-title" id="{@id}Label"></h4>\n                <button type="button" class="close" data-dismiss="modal">\n                    <span aria-hidden="true">&times;</span>\n                    <span class="sr-only">Close</span>\n                </button>\n            </div>\n            <div class="modal-body">\n            </div>\n            <div class="modal-footer">\n                <nav class="nav nav-fill"></nav>\n            </div>\n        </div>\n    </div>\n</div>',dialogIdx=0;function Dialog(t){if(t||(t={}),void 0!==t.btns){"string"==typeof t.btns&&(t.btns=[t.btns]);for(var n=-1,i=0;i<t.btns.length;i++)"string"==typeof t.btns[i]&&(t.btns[i]={text:t.btns[i]}),t.btns[i].isdefault&&(n=i);n<0&&(n=t.btns.length-1,t.btns[n].isdefault=!0),t.btns[n].type||(t.btns[n].type="primary"),t.defaultBtn=n}this.options=$.extend({id:"dlgModal"+dialogIdx++,size:"",btns:[{text:"取消",type:"secondary"},{text:"确定",isdefault:!0,type:"primary"}],defaultBtn:1,onsure:null,onshow:null,onshown:null,onhide:null,onhidden:null},t),this.box=$(this.options.id)}Dialog.prototype.generBtn=function(t,n){return t.type&&(t.class="btn-outline-"+t.type),'<a href="javascript:" class="nav-item btn '+(t.class?t.class:"btn-outline-secondary")+'" data-index="'+n+'">'+t.text+"</a>"},Dialog.prototype.show=function(t,n){this.box=$("#"+this.options.id),n||(n="系统提示"),this.box.length<1?($(document.body).append(dialogTpl.compile({id:this.options.id})),this.box=$("#"+this.options.id)):this.box.unbind();var i=this;Dialog.instance=i;for(var a=[],e=0;e<this.options.btns.length;e++)a.push(this.generBtn(this.options.btns[e],e));this.box.find(".modal-footer .nav").html(a.join("\n"));var o=this.box.find(".modal-dialog");o.removeClass("modal-sm").removeClass("modal-lg"),"sm"==this.options.size?o.addClass("modal-sm"):"lg"==this.options.size&&o.addClass("modal-lg"),this.box.find(".modal-title").text(n);var s=this.box.find(".modal-body");return s.html(t),this.box.on("hide.bs.modal",function(){i.options.onhide&&i.options.onhide(s,i.box),Dialog.instance=null}),this.box.on("hidden.bs.modal",function(){i.options.onhidden&&i.options.onhidden(s,i.box),i.box.remove()}),this.box.on("show.bs.modal",function(){i.options.onshow&&i.options.onshow(s,i.box)}),this.box.on("shown.bs.modal",function(){i.options.onshown&&i.options.onshown(s,i.box)}),this.box.find(".modal-footer .btn").click(function(){var t=!0,n=$(this).data("index");i.options.btns[n].click&&(t=i.options.btns[n].click.apply(this,[s,i.box])),n==i.options.defaultBtn&&i.options.onsure&&(t=i.options.onsure.apply(this,[s,i.box])),!1!==t&&i.box.modal("hide")}),this.box.modal("show"),this},Dialog.prototype.hide=function(){return this.box.modal("hide"),this};var dialog={alert:function(t,n,i){var a=!1,e="function"==typeof n;return new Dialog({btns:"确定",onsure:function(){if(e)return n(a=!0)},onhide:function(){!a&&e&&n(!1)}}).show(t,i)},confirm:function(t,n,i){return new Dialog({onsure:function(){if("function"==typeof n)return!0,n()},onhide:function(){if(!1)return i()}}).show(t)},prompt:function(t,a,n){return new Dialog({onshown:function(t){t.find("[name=confirm_input]").focus()},onsure:function(t){var n=t.find("[name=confirm_input]").val();if("function"==typeof a){var i=a(n);return!0===i&&!0,i}},onhide:function(){if(!1)return n()}}).show('<input type="text" name="confirm_input" class="form-control" />',t)},pickUser:function(o,n,s){var r=null;s||(s={});new Dialog({onshown:function(t){var n=t.find(".searchbtn"),i=t.find(".searchtext"),a=t.find(".list-group"),e=!1;n.click(function(){e||(e=!0,a.html('<span class="list-loading">加载中...</span>'),s.key=i.val(),$.ajax({url:o,type:"GET",dataType:"JSON",data:s,success:function(i){e=!1,i.status?i.data&&i.data.length?(a.html('<a href="javascript:" data-id="{@id}" class="list-group-item list-group-item-action">[{@id}]&nbsp;<i class="ion-md-person"></i> {@username}&nbsp;&nbsp;&nbsp;<small><i class="ion-md-phone-portrait"></i> {@mobile}</small></a>'.compile(i.data,!0)),a.find("a.list-group-item").click(function(){for(var t=$(this).data("id"),n=0;n<i.data.length;n++)if(i.data[n].id==t){r=i.data[n],a.find("a.list-group-item").removeClass("active"),$(this).addClass("active");break}})):a.html('<span class="list-loading"><i class="ion-md-warning"></i> 没有检索到会员</span>'):a.html('<span class="text-danger"><i class="ion-md-warning"></i> 加载失败</span>')}}))}).trigger("click")},onsure:function(t){return r?"function"==typeof n?n(r):void 0:(toastr.warning("没有选择会员!"),!1)}}).show('<div class="input-group"><input type="text" class="form-control searchtext" name="keyword" placeholder="根据会员id或名称，电话来搜索"/><div class="input-group-append"><a class="btn btn-outline-secondary searchbtn"><i class="ion-md-search"></i></a></div></div><div class="list-group mt-2"></div>',"请搜索并选择会员")}};if(jQuery(function(t){t(document).on("keydown",function(t){if(Dialog.instance){var n=Dialog.instance;13==t.keyCode&&n.box.find(".modal-footer .btn").eq(n.options.defaultBtn).trigger("click")}})}),jQuery.extend(jQuery.fn,{tags:function(t){var a=[],e='<span class="badge badge-info">{@label}<input type="hidden" name="'+t+'" value="{@label}"/><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></span>',n=$(this).parents(".form-control"),o=$('<span class="badge-group"></span>'),s=this;this.before(o),this.on("keyup",function(){var t=$(this).val().replace(/，/g,",");if(t&&-1<t.indexOf(",")){for(var n=t.split(","),i=0;i<n.length;i++)n[i]=n[i].replace(/^\s|\s$/g,""),n[i]&&-1===a.indexOf(n[i])&&(a.push(n[i]),o.append(e.compile({label:n[i]})));s.val("")}}).on("blur",function(){$(this).val($(this).val()+",").trigger("keyup")}).trigger("keyup"),o.on("click",".close",function(){var t=$(this).parents(".badge").find("input").val(),n=a.indexOf(t);n&&a.splice(n,1),$(this).parents(".badge").remove()}),n.click(function(){s.focus()})}}),$.fn.datetimepicker){var tooltips={today:"定位当前日期",clear:"清除已选日期",close:"关闭选择器",selectMonth:"选择月份",prevMonth:"上个月",nextMonth:"下个月",selectYear:"选择年份",prevYear:"上一年",nextYear:"下一年",selectDecade:"选择年份区间",prevDecade:"上一区间",nextDecade:"下一区间",prevCentury:"上个世纪",nextCentury:"下个世纪"},icons={time:"ion-md-time",date:"ion-md-calendar",up:"ion-md-arrow-dropup",down:"ion-md-arrow-dropdown",previous:"ion-md-arrow-dropleft",next:"ion-md-arrow-dropright",today:"ion-md-today",clear:"ion-md-trash",close:"ion-md-close"};$(".datepicker").datetimepicker({icons:icons,tooltips:tooltips,format:"YYYY-MM-DD",locale:"zh-cn",showClear:!0,showTodayButton:!0,showClose:!0,keepInvalid:!0}),$(".date-range").each(function(){var t=$(this).find("[name=fromdate],.fromdate"),n=$(this).find("[name=todate],.todate"),i={icons:icons,tooltips:tooltips,format:"YYYY-MM-DD",locale:"zh-cn",showClear:!0,showTodayButton:!0,showClose:!0,keepInvalid:!0};t.datetimepicker(i).on("dp.change",function(){t.val()&&n.data("DateTimePicker").minDate(t.val())}),n.datetimepicker(i).on("dp.change",function(){n.val()&&t.data("DateTimePicker").maxDate(n.val())})})}jQuery(function(r){var t=r(".breadcrumb"),n=t.data("menu");if(n){var i=r(".side-nav a[data-key="+n+"]"),a=[];if(0<i.length)if(i.is(".menu_top"))a.push('<li class="breadcrumb-item"><a href="javascript:"><i class="'+i.find("i").attr("class")+'"></i>&nbsp;'+i.text()+"</a></li>");else{var e=i.parents(".collapse").eq(0);e.addClass("show"),i.addClass("active");var o=e.siblings(".card-header").find("a.menu_top");a.push('<li class="breadcrumb-item"><a href="javascript:"><i class="'+o.find("i").attr("class")+'"></i>&nbsp;'+o.text()+"</a></li>"),a.push('<li class="breadcrumb-item"><a href="javascript:">'+i.text()+"</a></li>")}var s=t.data("title");s&&a.push('<li class="breadcrumb-item active" aria-current="page">'+s+"</li>"),t.html(a.join("\n"))}r(".checkall-btn").click(function(t){var n=r(this).data("target");n||(n="id");var i=r("[name="+n+"]");r(this).is(".active")?i.removeAttr("checked"):i.attr("checked",!0)}),r(".checkreverse-btn").click(function(t){var n=r(this).data("target");n||(n="id");for(var i=r("[name="+n+"]"),a=0;a<i.length;a++)i[a].checked?i.eq(a).removeAttr("checked"):i.eq(a).attr("checked",!0)}),r(".action-btn").click(function(t){t.preventDefault();var n=r(this).data("action");if(!n)return toastr.error("未知操作");if(n="action"+n.replace(/^[a-z]/,function(t){return t.toUpperCase()}),!window[n]||"function"!=typeof window[n])return toastr.error("未知操作");var i=r(this).data("needChecks");if(void 0===i&&(i=!0),i){var a=r(this).data("target");a||(a="id");var e=r("[name="+a+"]:checked");if(e.length<1)return toastr.warning("请选择需要操作的项目");for(var o=[],s=0;s<e.length;s++)o.push(e.eq(s).val());window[n](o)}else window[n]()}),r("a[rel=ajax]").click(function(t){t.preventDefault();var i=r(this),n=r(this).data("title");n||(n=r(this).text());new Dialog({btns:["确定"],onshow:function(n){r.ajax({url:i.attr("href"),success:function(t){n.html(t)}})}}).show('<p class="loading">加载中...</p>',n)}),r(".nav-tabs a").click(function(t){t.preventDefault(),r(this).tab("show")}),r(".custom-file .custom-file-input").on("change",function(){r(this).parents(".custom-file").find(".custom-file-label").text(r(this).val())}),r(".btn-primary[type=submit]").click(function(t){var n=r(this).parents("form"),i=this,a={url:r(n).attr("action"),type:"POST",dataType:"JSON",success:function(t){1==t.code?new Dialog({onhidden:function(){t.url?location.href=t.url:location.reload()}}).show(t.msg):(toastr.warning(t.msg),r(i).removeAttr("disabled"))}};if("multipart/form-data"==n.attr("enctype")){if(!FormData)return!0;a.data=new FormData(n[0]),a.cache=!1,a.processData=!1,a.contentType=!1}else a.data=r(n).serialize();t.preventDefault(),r(this).attr("disabled",!0),r.ajax(a)}),r(".pickuser").click(function(t){var n=r(this).parents(".input-group"),i=n.find("[name=member_id]"),a=n.find("[name=member_info]");dialog.pickUser(r(this).data("url"),function(t){i.val(t.id),a.val("["+t.id+"] "+t.username+(t.mobile?" / "+t.mobile:""))},r(this).data("filter"))})});